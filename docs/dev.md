## 基础概念

### 条目

条目（Entry）是系统最小的信息单元。一个条目包含如下基本信息：
* 标识符（ID），全局唯一。
* 名字（Name）。
* 内容类型（Content Type），指定内容的格式，如 `text/markdown`。
* 内容（Content），根据内容类型属性可存放不同的内容，如字符串、二进制等。支持多语言。
* 创建时间（Create Time），条目的创建时间，其值由系统生成，不可变。
* 修改时间（Update Time），条目的上次修改时间，其值由系统维护。

### 关系与链接

条目之间可以存在两种关系（Relation）：父子关系和朋友关系。

它们通过链接（Link）表示，将条目组成一个网络。

#### 父子关系

父子关系一般用来表示两个条目间存在直接的、逻辑上的先后关系。父子关系通过父链（Parent Link）和子链（Child Link）来表示。

例如，「Neovim」是「编辑器软件」的一种，那么可定义二者的父子关系，即：
* 「编辑器软件」有条子链，指向「Neovim 」。
* 「Neovim」有条父链，指向「编辑器软件」。

父链（或子链）包含下列信息：
* 目标条目（Target），链接的目标条目 ID。
* 标注（Label），链接携带的额外文本信息。

#### 朋友关系

与父子关系相对，朋友关系表示两个条目间不存在必然的逻辑先后关系。其主要用途是标识条目之间的额外信息。

例如：Neovim 源自于 Vim，但 Neovim 已经发展出了自己的生态系统。此时，可以在二者之间建立朋友关系，并附加文本「复刻」。

同一条目可与另一条目（甚至是自己）建立若干朋友关系（虽然从实际使用角度出发，并不建议这样做），不管是相关的条目还是链接的数量都没有限制。

### 属性

一个条目还可包含若干属性（Property），用来存储额外的信息。它很适合用来存放一些元信息。例如若条目是一本书，则可以用属性存储书的出版时间、作者等信息。

当然，你也可以将这些信息以文本的形式写到条目内容中。但这种情况下使用属性的一大优势是，它支持搜索以及简单的字符串匹配。关于搜索的内容详见后文。

### 附件

一个条目可以附加若干附件（Attachment），每个附件是一个单独的文件。附件包含如下信息：
* 附件名（Attachment Name），支持多语言。
* 附件文件路径（File Path），文件系统上的文件的路径。
* 创建时间（Create Time），附件的创建时间，由系统生成，不可变。
* 修改时间（Update Time），附件上次被修改的时间。

一个条目可以附加多个附件，同一个附件只能被附加到一个条目上。

## 核心功能

本系统最核心的功能是对条目、链接、属性和附件的增删改查（CRUD）操作。本系统暴露了 REST API 以支持不同的客户端。

这些信息存放在 SQLite 数据中，附件以文件形式存放在系统指定的文件夹中。用户可以利用其它软件（如 Syncthing）轻松在多台设备之间备份它们。

### 系统内置属性

系统可以识别一些属性，从而改变处理相关条目的方式，这些属性称为内置属性（Built-in Property）。例如，若一条目存在 `hidden` 属性，不管它的值是什么，该条目均无法通过搜索查询到。这些属性的创建、修改、管理等，均与用户自定义的属性相同。

详细的系统内置属性列表见附录一。

### 搜索

对于知识库而言，搜索一定是其最核心的功能。本系统支持一套简单但丰富的查询语言（Silver Brain Query Language，SBQL）对条目进行搜索。语法的 BNF 定义详见附录二。

#### 基础查询

基础查询（Basic Query）有以下两种情况：
* 单引号或双引号括起来的字符串。若要在字符串中包含引号，则需用 `\` 进行转义。
* 不包含一些特殊字符的普通字符串。所有用在其它语法中的字符串（比如引号、`&` 等）都不能在这里用。

基础查询可以搜索下列内容：
* 部分匹配条目的名字。
* 部分匹配祖先条目的名字。
* 完全匹配条目标签。

#### 过滤查询

过滤查询（Filter Query）用来判断条目是否满足特定的要求。其基本格式是 `<key> : <value>`。其中 `<key>` 是系统定义的过滤条件，`<value>` 是期望的值。

例如：
* `has: attachment` 会筛选出有附件的条目。
* `has: child` 会筛选出有子条目的条目。
* `prop: author` 会筛选出定义了 `author` 属性的条目。

有些 `<key>` 支持数值比较。在这种情况下，可以使用 `:<`、`:<=`、`:=`、`:!=`、`:>=`、`:>` 等操作符进行比较。

例如 `link_count :< 3` 可以过滤链接数（包括父链、子链和友链）少于 3 的条目。

系统支持的所有过滤条件见附录二。

#### 属性查询

属性查询（Property Query）用来进行简单的数值比较以匹配属性。它的基本格式是 `<key> <comparator> <value>`。这里的 `<key>` 和 `<value>` 都是字符串。

例如：`publish-time <= 2012` 判断属性 `publish-time` 的值要小于 `2012`。

系统支持 `=`、`!=`、`<`、`<=`、`>=`、`>` 这些大小比较，以及 `=~` 字符串匹配。当使用字符串匹配功能时，可以在 `<value>` 字符串中使用星号 `*` 来表示「任意字符串」。

## 其它功能

### 固定条目

用户可以指定若干条目将其固定（Pin）。固定住的条目将在 UI 中更轻松地搜索到。

## 用户接口

### 快速创建多个条目

以分号为分隔符，用户可以同时创建多个条目。

## 附录一、系统内置属性

### `hidden`

若存在该属性（不管值是什么），则相关条目无法通过普通搜索查询到，除非查询语句中包含 `has: hidden` 。

注意，该条目仍然会显示在相关条目的链接中。

## 附录二、Silver Brain Query Language（SBQL）

### 搜索语言 BNF 定义

```ebnf
<query> ::= <query> | <single-query> | <grouped-query>
    | <not-query> | <and-query> | <or-query>
    | <any-space> | ""

<single-query> ::= <string> | <filter-query> | <property-query>

<string> ::= <literal-string> | <quoted-string>

<literal-string> ::= [A-Z] | [a-z] | [0-9]
    | "~" | "`" | "@" | "#" | "$" | "%" | "^" | "-" | "_" | "+" | "[" | "]"
    | "{" | "}" | "\\" | ";" | "," | "." | "/" | "?"

<quoted-string> ::= '"' <characters> '"' | '"' <characters> '"'

<characters> ::= <characters> | [^\] | "\\" "\\" | "\\" '"'

<filter-query> ::= <string> ":" <string>

<property-query> ::= <string> <compare-operator> <string>

<compare-operator> ::= "=" | "!=" | "<" | "<=" | ">" | ">="

<grouped-query> ::= "(" <query> ")"

<not-query> ::= <not-operator> <single-query>

<not-operator> ::= "NOT" | "!"

<and-query> ::= <query> <and-operator> <query>

<and-operator> ::= "AND" | "&&" | <any-space>

<or-query> ::= <query> <or-operator> <query>

<or-operator> ::= "OR" | "||"

<any-space> ::= " " | "\r" | "\n" | "\t"
```

### 过滤查询

#### `has` 条件

用来判断条目拥有某一属性。它的值是个字符串。

例：`has: author`

#### `child_count` 条件

用来判断条目的总子条目数。它的值是个整数。

例：`child_count :< 3`

#### `link_count` 条件

用来判断条目的总链接数。它的值是个整数。

例：`link_count :> 2`

#### `parent_count` 条件

用来判断条目的总父条目数。它的值是个整数。

例：`parent_count := 2`

#### `create_time` 条件

用来判断条目的创建时间。它的值是个字符串。

例如要搜索创建时间早于 2023 年 10 月 23 日的条目：`create_time :< 2023-10-23`
